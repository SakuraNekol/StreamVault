# ---- 第一阶段：构建 Python 环境 ----
FROM python:3.11-alpine as python-builder

ENV TZ=Asia/Shanghai
RUN apk add --no-cache build-base libffi-dev

# 安装 f2 库和 yt-dlp
RUN pip install --upgrade pip && \
    pip install --no-cache-dir f2

# 下载 yt-dlp
ARG BUILD_VERSION=2025.06.30.052234
RUN wget -O /usr/local/bin/yt-dlp https://github.com/lemon8866/yt-dlp/releases/download/${BUILD_VERSION}/yt-dlp && \
    chmod a+rx /usr/local/bin/yt-dlp

---

# ---- 第二阶段：最终运行环境（纯 Alpine）----
FROM alpine

ENV TZ=Asia/Shanghai

# 安装 Java、Python 运行环境及其他依赖
RUN apk add --no-cache \
    openjdk8 \
    ffmpeg \
    python3 \
    py3-pip \
    libffi \
    libstdc++ \
    && python3 -m ensurepip && \
    pip install --no-cache-dir virtualenv

# 拷贝 Python 包（f2）、yt-dlp 等
COPY --from=python-builder /usr/local /usr/local
COPY --from=python-builder /usr/lib /usr/lib
COPY --from=python-builder /usr/include /usr/include

# 设置环境变量
ENV JAVA_HOME=/usr/lib/jvm/java-1.8-openjdk
ENV PATH=$JAVA_HOME/bin:$PATH
ENV YT_DLP_PATH=/usr/local/bin/yt-dlp

# 拷贝资源文件
COPY db /home/app/db/
COPY script /home/app/script/
RUN mkdir -p /app/resources

# 拷贝 JAR 文件
ADD spirit-0.0.1-SNAPSHOT.jar /app/app.jar

# 设置工作目录、挂载点
WORKDIR /app
VOLUME ["/tmp", "/app"]

# 启动 Java 应用
ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "/app/app.jar", "--spring.profiles.active=docker"]
