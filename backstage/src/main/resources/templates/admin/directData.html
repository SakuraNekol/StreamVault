<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>链接解析-StreamVault</title>
    <th:block th:insert="~{admin/include/header :: metaHeader}"></th:block>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../static/css/style.min.css" rel="stylesheet">
    <link href="../static/js/skin/laypage.css" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #ffffff;
        }
        
        .card-header {
            background: #f9fafb;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
            border-radius: 8px 8px 0 0 !important;
            padding: 12px 20px;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            margin-bottom: 6px;
        }
        
        .form-control {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #ffffff;
            transition: all 0.2s ease;
            font-size: 14px;
            padding: 10px 12px;
        }
        
        .form-control:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: #ffffff;
            outline: none;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            padding: 10px 20px;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .btn-primary:focus {
            background-color: #2563eb;
            color: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            outline: none;
        }
        
        .btn-success {
            background-color: #10b981;
            color: #ffffff;
        }
        
        .btn-success:hover {
            background-color: #059669;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .btn-info {
            background-color: #06b6d4;
            color: #ffffff;
        }
        
        .btn-info:hover {
            background-color: #0891b2;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: #ffffff;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
            color: #ffffff;
            transform: translateY(-1px);
        }
        
        .btn-outline-secondary {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: #6b7280;
        }
        
        .btn-outline-secondary:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }
        
        .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
            color: #3b82f6;
        }
        
        #loadingDiv {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 30px 20px;
        }
        
        #resultDiv .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }
        
        #resultDiv .card-header {
            background: #f9fafb;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-title {
            color: #111827;
            font-weight: 600;
            line-height: 1.4;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .card-text {
            color: #6b7280;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 0;
        }
        
        .input-group .form-control {
            background-color: #ffffff;
            font-size: 13px;
        }
        
        .input-group-append .btn {
            border-radius: 0 6px 6px 0;
            background-color: #6b7280;
            border-color: #6b7280;
            color: #ffffff;
        }
        
        .input-group-append .btn:hover {
            background-color: #4b5563;
            border-color: #4b5563;
            color: #ffffff;
        }
        
        .form-check-input:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .form-check-label {
            font-weight: 400;
            color: #374151;
            font-size: 14px;
        }
        
        .notice-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .notice-card .card-header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .notice-list {
            margin: 0;
            padding-left: 20px;
            font-size: 14px;
        }
        
        .notice-list li {
            margin-bottom: 6px;
            color: #6b7280;
            line-height: 1.6;
        }
        
        img.img-fluid {
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        hr {
            border-top: 1px solid #e5e7eb;
            margin: 16px 0;
        }
        
        .lyear-layout-content {
            background: #f3f4f6;
        }
        
        .container-fluid {
            background: transparent;
        }
        
        .alert-info {
            background-color: #eff6ff;
            border-color: #dbeafe;
            color: #1e40af;
            font-size: 14px;
            padding: 12px 16px;
            border-radius: 6px;
        }
        
        .alert-info i {
            margin-right: 6px;
        }
        
        .mb-3 {
            margin-bottom: 12px !important;
        }
        
        .mt-2 {
            margin-top: 8px !important;
        }
        
        .mt-3 {
            margin-top: 12px !important;
        }
        
        .ml-1 {
            margin-left: 4px !important;
        }
        
        .ml-2 {
            margin-left: 8px !important;
        }
        
        @media (max-width: 768px) {
            .col-md-4, .col-md-8, .col-md-3, .col-md-9 {
                margin-bottom: 12px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .ml-1, .ml-2 {
                margin-left: 0 !important;
            }
        }
        
        .video-item {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
        }
        
        .video-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .video-item-content {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        
        .video-cover {
            width: 100px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .video-info {
            flex: 1;
            min-width: 0;
        }
        
        .video-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 6px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #6b7280;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .meta-item i {
            font-size: 14px;
        }
        
        .badge-dash {
            background-color: #fef3c7;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .video-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .video-actions .btn {
            padding: 4px 10px;
            font-size: 12px;
            min-width: 60px;
        }
        
        .platform-info {
            font-size: 14px;
            color: #374151;
        }
        
        .videos-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .video-item-content {
                flex-direction: column;
            }
            
            .video-cover {
                width: 100%;
                height: 120px;
            }
            
            .video-actions {
                width: 100%;
            }
            
            .video-actions .btn {
                flex: 1;
                min-width: auto;
            }
        }
        
        .single-video-layout {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .video-cover-section {
            flex-shrink: 0;
        }
        
        .video-cover-large {
            width: 140px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .video-details-section {
            flex: 1;
            min-width: 0;
        }
        
        .video-title-large {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 8px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .video-meta-large {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .meta-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .meta-tag i {
            font-size: 14px;
        }
        
        .badge-referer {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .video-actions-large {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .video-actions-large .btn {
            min-width: 100px;
        }
        
        .links-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .link-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .link-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            margin: 0;
        }
        
        .image-gallery-header {
            margin-bottom: 16px;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .image-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
        }
        
        .image-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .image-thumb {
            width: 100%;
            height: 140px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .image-actions {
            display: flex;
            justify-content: center;
        }
        
        .image-actions .btn {
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .single-video-layout {
                flex-direction: column;
            }
            
            .video-cover-large {
                width: 100%;
                height: 160px;
            }
            
            .video-actions-large {
                width: 100%;
            }
            
            .video-actions-large .btn {
                flex: 1;
                min-width: auto;
            }
            
            .images-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 12px;
            }
            
            .image-thumb {
                height: 120px;
            }
        }
    </style>
</head>

<body>
<div class="lyear-layout-web">

    <div class="lyear-layout-container">

        <!--左侧导航-->
        <div th:insert="~{admin/include/common :: headermenu}"></div>
        <!--End 头部信息-->
        <!--End 头部信息-->

        <!--页面主要内容-->
        <main class="lyear-layout-content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4>视频链接解析</h4>
                            </div>
                            <div class="card-body">
                                <!-- 表单区域 -->
                                <form id="directDataForm">
                                    <div class="form-group">
                                        <label for="videoUrl">视频分享链接</label>
                                        <input type="text" class="form-control" id="videoUrl" name="originaladdress" 
                                               placeholder="请输入视频平台分享的链接" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="onlyGetLink" checked>
                                            <label class="form-check-label" for="onlyGetLink">
                                                仅获取链接地址
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="mdi mdi-send"></i> 提交解析
                                    </button>
                                </form>
                                
                                <!-- 加载状态 -->
                                <div id="loadingDiv" style="display: none; text-align: center; margin-top: 20px;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">解析中...</span>
                                    </div>
                                    <p class="mt-2">正在解析中，请稍候...</p>
                                </div>
                                
                                <!-- 结果显示区域 -->
                                <div id="resultDiv" style="display: none; margin-top: 30px;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>解析结果</h5>
                                        </div>
                                        <div class="card-body" id="resultContent">
                                            <!-- 动态内容将在这里显示 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 注意事项区域 - 移到页底 -->
                        <div class="card notice-card mt-4">
                            <div class="card-header">
                                <h5><i class="mdi mdi-information-outline"></i> 使用说明</h5>
                            </div>
                            <div class="card-body">
                                <ul class="notice-list">
                                     <li>部分平台视频为DASH流格式，需要分别获取视频和音频链接</li>
                                     <li>检测到多个视频时会显示视频列表，可分别选择复制链接</li>
                                 </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!--End 页面主要内容-->
    </div>

    <!--    模态框 start-->
    <div class="updateData layui-form" style="display: none;padding: 20px;">
        <input class="optionid" type="hidden">
        <div class="layui-inline">
            <label class="layui-form-label">视频名称</label>
            <div class="layui-input-inline">
                <input  type="text" name="videoname"  autocomplete="off" class="videoname layui-input">
            </div>
        </div>
        <div class="layui-inline">
            <label class="layui-form-label">视频简介</label>
            <div class="layui-input-inline">
                <input  type="text" name="videodesc"  autocomplete="off" class="videodesc layui-input">
            </div>
        </div>
        <div class="buttondiv" style=" padding-left: 5%; padding-top: 5%; "><button type="button" class="layui-btn">保存信息</button></div>
    </div>

    <!--    模态框end-->
</div>

<script type="text/javascript" src="../static/js/jquery.min.js"></script>
<script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../static/js/perfect-scrollbar.min.js"></script>
<script type="text/javascript" src="../static/js/main.min.js"></script>
<script type="text/javascript" src="../static/js/laypage.js"></script>
<script src="../static/js/layer/layer.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function() {
    /**
     * 表单提交处理函数
     * 处理视频链接解析的表单提交
     */
    $('#directDataForm').on('submit', function(e) {
        e.preventDefault();
        
        const videoUrl = $('#videoUrl').val().trim();
        const onlyGetLink = $('#onlyGetLink').is(':checked');
        
        // 验证输入
        if (!videoUrl) {
            layer.msg('请输入视频分享链接', {icon: 2});
            return;
        }
        
        // 显示加载状态
        showLoading();
        
        // 构建API URL
        let apiUrl = '/admin/api/directData';
        if (onlyGetLink) {
            apiUrl += '?type=2';
        }else{
        	apiUrl += '?type=1';
        }
        
        // 发送请求
        $.ajax({
            url: apiUrl,
            type: 'POST',
            data: {
                originaladdress: videoUrl
            },
            success: function(response) {
                console.log('API响应成功:', response);
                hideLoading();
                handleApiResponse(response, onlyGetLink);
            },
            error: function(xhr, status, error) {
                console.error('API请求失败:', error);
                hideLoading();
                layer.msg('请求失败，请稍后重试', {icon: 2});
            }
        });
    });
    
    /**
     * 显示加载状态
     */
    function showLoading() {
        $('#loadingDiv').show();
        $('#resultDiv').hide();
        $('#submitBtn').prop('disabled', true).html('<i class="mdi mdi-loading mdi-spin"></i> 解析中...');
    }
    
    /**
     * 隐藏加载状态
     */
    function hideLoading() {
        $('#loadingDiv').hide();
        $('#submitBtn').prop('disabled', false).html('<i class="mdi mdi-send"></i> 提交解析');
    }
    
    /**
     * 处理API响应
     * @param {Object} response - API响应数据
     * @param {boolean} onlyGetLink - 是否仅获取链接地址
     */
    function handleApiResponse(response, onlyGetLink) {
        if (response.resCode === '000001') {
            if (onlyGetLink && response.record) {
                const record = response.record;
                if (record.type === 'multiple') {
                    renderMultipleVideos(record);
                } else {
                    renderVideoInfo(record);
                }
            } else {
                layer.msg(response.message || '提交成功', {icon: 1});
                $('#resultDiv').hide();
            }
        } else if (response.resCode === '999998' || response.resCode === '999997') {
            layer.msg(response.message || '解析失败', {icon: 2});
            $('#resultDiv').hide();
        } else {
            layer.msg(response.message || '解析失败', {icon: 2});
            $('#resultDiv').hide();
        }
    }
    
    /**
     * 渲染视频信息
     * @param {Object} record - 视频记录数据
     */
    function renderVideoInfo(record) {
        const platform = record.platform || '未知平台';
        const mediaType = record.mediaType || 'video';
        const title = record.title || '无标题';
        const author = record.author || '未知作者';
        const duration = record.duration ? formatDuration(record.duration) : '未知';
        const videoUrl = record.videoUrl || '';
        const coverUrl = record.coverUrl || '';
        const audioUrl = record.audioUrl || '';
        const isDash = record.isDash || false;
        const needReferer = record.needReferer || false;
        const referer = record.referer || '';
        const imageUrls = record.imageUrls || [];
        
        let mediaContent = '';
        let actionButtons = '';
        
        if (mediaType === 'video') {
            mediaContent = `
                <div class="single-video-layout">
                    <div class="video-cover-section">
                        ${coverUrl ? `<img src="${coverUrl}" class="video-cover-large" alt="视频封面" referrerpolicy="no-referrer">` : ''}
                    </div>
                    <div class="video-details-section">
                        <h5 class="video-title-large">${escapeHtml(title)}</h5>
                        <div class="video-meta-large">
                            <span class="meta-tag"><i class="mdi mdi-monitor"></i> ${platform}</span>
                            <span class="meta-tag"><i class="mdi mdi-account"></i> ${escapeHtml(author)}</span>
                            <span class="meta-tag"><i class="mdi mdi-clock"></i> ${duration}</span>
                            ${isDash ? '<span class="meta-tag badge-dash">DASH</span>' : ''}
                            ${needReferer ? '<span class="meta-tag badge-referer">需Referer</span>' : ''}
                        </div>
                        <div class="video-actions-large">
                            ${videoUrl ? `<button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(videoUrl)}')">
                                <i class="mdi mdi-content-copy"></i> 复制链接
                            </button>` : ''}
                            ${audioUrl ? `<button class="btn btn-info" onclick="copyToClipboard('${escapeHtml(audioUrl)}')">
                                <i class="mdi mdi-music"></i> 复制音频
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            actionButtons = `
                <div class="links-section">
                    ${videoUrl ? `
                    <div class="link-item">
                        <label class="link-label">视频链接</label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${escapeHtml(videoUrl)}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('${escapeHtml(videoUrl)}')">
                                    <i class="mdi mdi-content-copy"></i> 复制
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    ${audioUrl ? `
                    <div class="link-item">
                        <label class="link-label">音频链接</label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${escapeHtml(audioUrl)}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('${escapeHtml(audioUrl)}')">
                                    <i class="mdi mdi-content-copy"></i> 复制
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        } else if (mediaType === 'audio') {
            mediaContent = `
                <div class="single-video-layout">
                    <div class="video-cover-section">
                        ${coverUrl ? `<img src="${coverUrl}" class="video-cover-large" alt="音频封面" referrerpolicy="no-referrer">` : ''}
                    </div>
                    <div class="video-details-section">
                        <h5 class="video-title-large">${escapeHtml(title)}</h5>
                        <div class="video-meta-large">
                            <span class="meta-tag"><i class="mdi mdi-music"></i> ${platform}</span>
                            <span class="meta-tag"><i class="mdi mdi-account"></i> ${escapeHtml(author)}</span>
                            <span class="meta-tag"><i class="mdi mdi-clock"></i> ${duration}</span>
                        </div>
                        <div class="video-actions-large">
                            ${videoUrl ? `<button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(videoUrl)}')">
                                <i class="mdi mdi-content-copy"></i> 复制链接
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            actionButtons = `
                <div class="links-section">
                    ${videoUrl ? `
                    <div class="link-item">
                        <label class="link-label">音频链接</label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="${escapeHtml(videoUrl)}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('${escapeHtml(videoUrl)}')">
                                    <i class="mdi mdi-content-copy"></i> 复制
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        } else if (mediaType === 'image') {
            let imagesHtml = imageUrls.map((url, index) => `
                <div class="image-item">
                    <img src="${escapeHtml(url)}" class="image-thumb" alt="图片${index + 1}" referrerpolicy="no-referrer" onclick="window.open('${escapeHtml(url)}', '_blank')">
                    <div class="image-actions">
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${escapeHtml(url)}')">
                            <i class="mdi mdi-content-copy"></i> 复制
                        </button>
                    </div>
                </div>
            `).join('');
            
            mediaContent = `
                <div class="image-gallery-header">
                    <h5 class="video-title-large">${escapeHtml(title)}</h5>
                    <div class="video-meta-large">
                        <span class="meta-tag"><i class="mdi mdi-image"></i> ${platform}</span>
                        <span class="meta-tag"><i class="mdi mdi-account"></i> ${escapeHtml(author)}</span>
                        <span class="meta-tag"><i class="mdi mdi-image-multiple"></i> ${imageUrls.length}张</span>
                    </div>
                </div>
            `;
            
            actionButtons = `
                <div class="images-grid">
                    ${imagesHtml}
                </div>
            `;
        }
        
        const resultHtml = `
            ${mediaContent}
            ${actionButtons ? '<hr>' : ''}
            ${actionButtons}
        `;
        
        $('#resultContent').html(resultHtml);
        $('#resultDiv').show();
        
        layer.msg('解析成功！', {icon: 1});
    }
    
    /**
     * 渲染多个视频
     * @param {Object} record - 多视频记录数据
     */
    function renderMultipleVideos(record) {
        const platform = record.platform || '未知平台';
        const totalCount = record.totalCount || 0;
        const videos = record.videos || [];
        
        let videosHtml = videos.map((video, index) => {
            const title = video.title || '无标题';
            const author = video.author || '未知作者';
            const duration = video.duration ? formatDuration(video.duration) : '未知';
            const videoUrl = video.videoUrl || '';
            const audioUrl = video.audioUrl || '';
            const coverUrl = video.coverUrl || '';
            const isDash = video.isDash || false;
            
            return `
                <div class="video-item mb-3">
                    <div class="video-item-content">
                        ${coverUrl ? `<img src="${escapeHtml(coverUrl)}" class="video-cover" alt="视频${index + 1}封面" referrerpolicy="no-referrer">` : ''}
                        <div class="video-info">
                            <h6 class="video-title"><strong>${index + 1}. ${escapeHtml(title)}</strong></h6>
                            <div class="video-meta">
                                <span class="meta-item"><i class="mdi mdi-account"></i> ${escapeHtml(author)}</span>
                                <span class="meta-item"><i class="mdi mdi-clock"></i> ${duration}</span>
                                ${isDash ? '<span class="meta-item badge-dash">DASH</span>' : ''}
                            </div>
                            <div class="video-actions">
                                ${videoUrl ? `<button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${escapeHtml(videoUrl)}')">
                                    <i class="mdi mdi-content-copy"></i> 复制
                                </button>` : ''}
                                ${audioUrl ? `<button class="btn btn-sm btn-info" onclick="copyToClipboard('${escapeHtml(audioUrl)}')">
                                    <i class="mdi mdi-music"></i> 音频
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        const resultHtml = `
            <div class="alert alert-info">
                <i class="mdi mdi-information"></i> 检测到 <strong>${totalCount}</strong> 个视频，请选择需要下载的视频
            </div>
            <div class="platform-info mb-3">
                <strong>平台：</strong>${platform}
            </div>
            <div class="videos-list">
                ${videosHtml}
            </div>
        `;
        
        $('#resultContent').html(resultHtml);
        $('#resultDiv').show();
        
        layer.msg('成功解析 ' + totalCount + ' 个视频', {icon: 1});
    }
    
    /**
     * 格式化时长
     * @param {number} seconds - 秒数
     * @returns {string} 格式化后的时长
     */
    function formatDuration(seconds) {
        if (!seconds) return '未知';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    }
    
    /**
     * HTML转义
     * @param {string} text - 要转义的文本
     * @returns {string} 转义后的文本
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    /**
     * 复制文本到剪贴板
     * @param {string} text - 要复制的文本
     */
    window.copyToClipboard = function(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                layer.msg('链接已复制到剪贴板', {icon: 1});
            }).catch(function(err) {
                console.error('复制失败:', err);
                fallbackCopyTextToClipboard(text);
            });
        } else {
            fallbackCopyTextToClipboard(text);
        }
    };
    
    /**
     * 备用复制方法
     * @param {string} text - 要复制的文本
     */
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                layer.msg('链接已复制到剪贴板', {icon: 1});
            } else {
                layer.msg('复制失败，请手动复制', {icon: 2});
            }
        } catch (err) {
            console.error('复制失败:', err);
            layer.msg('复制失败，请手动复制', {icon: 2});
        }
        
        document.body.removeChild(textArea);
    }
});
</script>
</body>
</html>