<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>线程池监控 - StreamVault</title>
    <th:block th:insert="admin/include/header :: metaHeader"></th:block>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../static/css/style.min.css" rel="stylesheet">
    <link href="../static/js/skin/laypage.css" rel="stylesheet">
    <style>
        .status-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .status-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: 500;
            color: #333;
        }
        .status-value {
            color: #666;
        }
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        .status-idle {
            color: #6c757d;
        }
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

    </style>
</head>
<body>
    <div class="lyear-layout-web">
        <div class="lyear-layout-container">
			<div th:include="admin/include/common :: headermenu"></div>
            
            <main class="lyear-layout-content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4><i class="mdi mdi-monitor"></i> 线程池监控</h4>
                                </div>
                                <div class="card-body">
                                    <div class="text-center mb-3">
                                        <button class="btn btn-primary" onclick="refreshStatus()">刷新状态</button>
                                    </div>
                                    <br/>
                                    <div class="row" id="statusContainer">
                                        <!-- 状态卡片将在这里动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

	<script type="text/javascript" src="../static/js/jquery.min.js"></script>
	<script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../static/js/perfect-scrollbar.min.js"></script>
	<script type="text/javascript" src="../static/js/main.min.js"></script>
	<script type="text/javascript" src="../static/js/laypage.js"></script>
	<script src="../static/js/layer/layer.js" type="text/javascript"></script>
    <script>
        $(document).ready(function() {
            refreshStatus();
        });
        
        function refreshStatus() {
            $.ajax({
                url: '/admin/api/getThreadPoolStatus',
                type: 'GET',
                success: function(response) {
                    if (response.resCode === '000001') {
                        renderStatus(response.record);
                    } else {
                        console.error('获取线程池状态失败:', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('请求失败:', error);
                }
            });
        }
        
        function renderStatus(data) {
            const container = $('#statusContainer');
            container.empty();
            
            // 渲染视频解析线程池状态
            if (data.analysis) {
                container.append(createAnalysisCards(data.analysis));
            }
            
            // 渲染收藏夹处理线程池状态
            if (data.collect) {
                container.append(createCollectCard(data.collect));
            }
        }
        
        function createAnalysisCards(analysisData) {
            let html = '';
            
            // 国内平台线程池
            if (analysisData.domestic) {
                html += createThreadPoolCard(analysisData.domestic, 'primary');
            }
            
            // 哔哩哔哩线程池
            if (analysisData.bilibili) {
                html += createThreadPoolCard(analysisData.bilibili, 'info');
            }
            
            // YouTube等国外平台线程池
            if (analysisData.ytdlp) {
                html += createThreadPoolCard(analysisData.ytdlp, 'success');
            }
            
            return html;
        }
        
        /**
         * 创建收藏夹任务监控卡片
         * 适配Quartz调度器监控数据
         */
        function createCollectCard(collectData) {
            if (collectData.quartz) {
                return createQuartzCard(collectData.quartz, 'warning');
            }
            return '';
        }
        
        /**
         * 创建Quartz调度器监控卡片
         */
        function createQuartzCard(quartzData, cardType) {
            const isStarted = quartzData.isStarted;
            const hasError = quartzData.error || quartzData.schedulerError;
            const statusClass = hasError ? 'text-danger' : (isStarted ? 'text-success' : 'text-warning');
            const statusText = hasError ? '错误' : (isStarted ? '运行中' : '已停止');
            
            let statusItems = `
                <div class="status-item">
                    <span class="status-label">调度器类型:</span>
                    <span class="status-value">${quartzData.schedulerType || 'Quartz Scheduler'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">调度器状态:</span>
                    <span class="status-value ${statusClass}">${statusText}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">总任务数:</span>
                    <span class="status-value">${quartzData.totalTasks || 0}</span>
                </div>
                <div class="status-item">
	                <span class="status-label">最大同时运行(固定):</span>
	                <span class="status-value">2</span>
           		 </div>
                <div class="status-item">
                    <span class="status-label">空闲任务:</span>
                    <span class="status-value status-idle">${quartzData.idleTasks || 0}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">正在执行:</span>
                    <span class="status-value">${quartzData.executingJobCount || 0} 个任务</span>
                </div>`;
            
            // 如果有错误信息，显示错误详情
            if (hasError) {
                const errorMsg = quartzData.error || quartzData.schedulerError;
                statusItems += `
                <div class="status-item">
                    <span class="status-label">错误信息:</span>
                    <span class="status-value text-danger">${errorMsg}</span>
                </div>`;
            }
            
            // 如果有待机模式信息，显示待机状态
            if (quartzData.isInStandbyMode !== undefined) {
                statusItems += `
                <div class="status-item">
                    <span class="status-label">待机模式:</span>
                    <span class="status-value">${quartzData.isInStandbyMode ? '是' : '否'}</span>
                </div>`;
            }
            
            return `
                <div class="col-lg-6 col-md-12">
                    <div class="status-card">
                        <div class="status-header">
                            <h5 class="text-${cardType}">
                                <i class="mdi mdi-clock-outline"></i> ${quartzData.schedulerName || '收藏夹任务调度器'}
                            </h5>
                        </div>
                        ${statusItems}
                    </div>
                </div>
            `;
        }
        
        function createThreadPoolCard(poolData, cardType) {
            const isActive = poolData.activeCount > 0;
            const activeClass = isActive ? 'status-active' : 'status-idle';
            
            let statusItems = '';
            
            if (poolData.poolType === 'SingleThreadExecutor') {
                // 单线程池的特殊显示
                statusItems = `
                    <div class="status-item">
                        <span class="status-label">线程池类型:</span>
                        <span class="status-value">${poolData.poolType}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">状态:</span>
                        <span class="status-value ${poolData.isShutdown ? 'text-danger' : 'text-success'}">
                            ${poolData.isShutdown ? '已关闭' : '运行中'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">说明:</span>
                        <span class="status-value">${poolData.description}</span>
                    </div>
                `;
            } else {
                // 普通线程池的显示
                statusItems = `
                    <div class="status-item">
                        <span class="status-label">核心线程数:</span>
                        <span class="status-value">${poolData.corePoolSize}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">最大线程数:</span>
                        <span class="status-value">${poolData.maximumPoolSize}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">当前线程数:</span>
                        <span class="status-value">${poolData.poolSize}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">活跃线程数:</span>
                        <span class="status-value ${activeClass}">${poolData.activeCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">队列任务数:</span>
                        <span class="status-value">${poolData.queueSize}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">总任务数:</span>
                        <span class="status-value">${poolData.taskCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">已完成任务:</span>
                        <span class="status-value">${poolData.completedTaskCount}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">状态:</span>
                        <span class="status-value ${poolData.isShutdown ? 'text-danger' : 'text-success'}">
                            ${poolData.isShutdown ? '已关闭' : '运行中'}
                        </span>
                    </div>
                `;
            }
            
            return `
                <div class="col-lg-6 col-md-12">
                    <div class="status-card">
                        <div class="status-header">
                            <h5 class="text-${cardType}">
                                <i class="mdi mdi-server"></i> ${poolData.poolName}
                            </h5>
                        </div>
                        ${statusItems}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>