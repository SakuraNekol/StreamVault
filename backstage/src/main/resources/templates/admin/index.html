<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>StreamVault-管理</title>
    <th:block th:insert="~{admin/include/header :: metaHeader}"></th:block>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../static/css/style.min.css" rel="stylesheet">
    <style>
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .video-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .video-cover {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 比例 */
            overflow: hidden;
            background: #f5f5f5;
        }
        
        .video-cover img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .video-cover img.loaded {
            opacity: 1;
        }
        
        /* 骨架屏样式 */
        .skeleton {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton.hide {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* 隐私保护相关样式 */
        .video-cover.is-private::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1;
        }

        .video-cover.is-private::after {
            content: '\F0425';
            font-family: 'Material Design Icons';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #666;
            z-index: 2;
        }
        
        .video-info {
            padding: 12px;
        }
        
        .video-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 40px;
        }

        .video-title.is-private {
            color: transparent;
            text-shadow: 0 0 8px rgba(0,0,0,0.5);
        }
        
        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }
        
        .video-platform {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            background: #f0f0f0;
        }
        
        .video-time {
            color: #999;
        }
        
        .video-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 3;
        }
        
        .video-card:hover .video-play {
            opacity: 1;
        }
        
        .video-play i {
            color: #fff;
            font-size: 24px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
                padding: 15px;
            }
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .video-container video {
             max-width: 100%;
             max-height: 100%;
             object-fit: contain;
             background: #000;
         }
        @media (max-width: 768px) {
            .layui-layer {
                margin: 10px !important;
            }
            .layui-layer-content {
                overflow: hidden !important;
            }
            .video-container video::-webkit-media-controls-panel {
                background-color: rgba(0,0,0,0.8);
            }
            .table-responsive {
                font-size: 14px;
            }
            
            .btn-group-sm .btn {
                padding: 0.25rem 0.4rem;
                font-size: 12px;
            }
            .playVideo {
                min-width: 32px;
                min-height: 32px;
            }
        }
        
        @media (max-width: 480px) {
             .card-body {
                 padding: 0.75rem;
             }
             
             .table th, .table td {
                 padding: 0.5rem 0.25rem;
             }
         }
        @media (orientation: landscape) and (max-height: 500px) {
            .layui-layer {
                margin: 5px !important;
            }
        }
    </style>
</head>

<body>
<div class="lyear-layout-web">
    <div class="lyear-layout-container">
        <div th:insert="~{admin/include/common :: headermenu}"></div>
        
        <main class="lyear-layout-content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="card-title mb-0">视频库</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="video-grid" id="videoGrid">
                                </div>
                                <div class="loading" id="loading" style="display: none;">
                                    <i class="mdi mdi-loading mdi-spin"></i> 加载中...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script type="text/javascript" src="../static/js/jquery.min.js"></script>
<script type="text/javascript" src="../static/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../static/js/perfect-scrollbar.min.js"></script>
<script type="text/javascript" src="../static/js/main.min.js"></script>
<script src="../static/js/layer/layer.js" type="text/javascript"></script>
<script>
    var page = 1;
    var isLoading = false;
    var hasMore = true;
    
    $(function(){
        findList(page);
        
        // 使用节流函数优化滚动事件
        var throttleTimer;
        $(window).scroll(function() {
            if (throttleTimer) {
                return;
            }
            
            throttleTimer = setTimeout(function() {
                if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
                    if (!isLoading && hasMore) {
                        page++;
                        findList(page);
                    }
                }
                throttleTimer = null;
            }, 200);
        });
    });
    
    function formatTime(time) {
        if(!time) return '';
        return new Date(time).toLocaleString();
    }
    
    function playVideo(videourl, isPrivate) {
    	showVideo(videourl);
    }
    
    function showVideo(videourl) {
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        var screenWidth = window.innerWidth || document.documentElement.clientWidth;
        var screenHeight = window.innerHeight || document.documentElement.clientHeight;
        var dialogWidth, dialogHeight;
        if (isMobile || screenWidth < 768) {
            dialogWidth = Math.min(screenWidth - 20, screenWidth * 0.95) + 'px';
            dialogHeight = Math.min(screenHeight - 60, screenHeight * 0.8) + 'px';
        } else if (screenWidth < 1200) {
            dialogWidth = Math.min(screenWidth * 0.8, 600) + 'px';
            dialogHeight = Math.min(screenHeight * 0.7, 450) + 'px';
        } else {
            dialogWidth = '800px';
            dialogHeight = '530px';
        }
         var html = '<div class="video-container" style="position: relative; width: 100%; height: 100%; background: #000;">' +
                   '<video src="' + videourl + '" ' +
                   'width="100%" height="100%" ' +
                   'controls="controls" ' +
                   'preload="metadata" ' +
                   'playsinline ' +  // iOS内联播放
                   'webkit-playsinline ' +  // 旧版iOS支持
                   'x5-video-player-type="h5" ' +  // 腾讯X5内核优化
                   'x5-video-player-fullscreen="true" ' +  // X5全屏支持
                   'x5-video-orientation="portraint" ' +  // X5竖屏优化
                   'style="object-fit: contain; background: #000;">' +
                   '您的浏览器不支持视频播放' +
                   '</video>' +
                   '</div>';
        
        // 打开弹窗
        var layerIndex = layer.open({
            type: 1,
            skin: 'layui-layer-rim',
            area: [dialogWidth, dialogHeight],
            content: html,
            title: '视频播放',
            maxmin: !isMobile, // 移动端禁用最大化最小化
            resize: !isMobile, // 移动端禁用拖拽调整
            move: !isMobile,   // 移动端禁用拖拽移动
            success: function(layero, index) {
                console.log('视频弹窗打开成功');
                
                // 获取视频元素
                var video = layero.find('video')[0];
                if (video) {
                    // 移动端自动播放优化
                    if (isMobile) {
                        // 尝试自动播放（某些浏览器可能阻止）
                        var playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(function(error) {
                                console.log('自动播放被阻止，需要用户手动播放');
                            });
                        }
                    }
                    
                    // 添加视频事件监听
                    video.addEventListener('loadstart', function() {
                        console.log('视频开始加载');
                    });
                    
                    video.addEventListener('error', function(e) {
                        console.log('视频加载错误:', e);
                        layer.msg('视频加载失败，请检查网络连接', {icon: 2});
                    });
                    
                    // 移动端触摸优化
                    if (isMobile) {
                        video.addEventListener('touchstart', function(e) {
                            // 防止双击缩放
                            e.preventDefault();
                        });
                    }
                }
            },
            end: function() {
                console.log('视频弹窗关闭');
            }
        });
    }
    
    
    // 懒加载初始化函数
    function initLazyLoading() {
        // 检查浏览器是否支持Intersection Observer
        if ('IntersectionObserver' in window) {
            const imageObserver = new IntersectionObserver(function(entries, observer) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px' // 提前50px开始加载
            });
            
            // 观察所有未加载的图片
            document.querySelectorAll('.lazy-image:not(.loaded)').forEach(function(img) {
                imageObserver.observe(img);
            });
        } else {
            // 降级处理：直接加载所有图片
            document.querySelectorAll('.lazy-image:not(.loaded)').forEach(function(img) {
                loadImage(img);
            });
        }
    }
    
    // 图片加载函数
    function loadImage(img) {
        const $img = $(img);
        const $skeleton = $img.siblings('.skeleton');
        const src = $img.attr('data-src');
        
        if (src) {
            // 创建新的Image对象预加载
            const newImg = new Image();
            
            newImg.onload = function() {
                // 图片加载成功
                $img.attr('src', src).addClass('loaded');
                $skeleton.addClass('hide');
                
                // 延迟移除骨架屏
                setTimeout(function() {
                    $skeleton.remove();
                }, 300);
            };
            
            newImg.onerror = function() {
                // 图片加载失败，使用默认图片
                $img.attr('src', '/static/images/noimage.jpg').addClass('loaded');
                $skeleton.addClass('hide');
                
                setTimeout(function() {
                    $skeleton.remove();
                }, 300);
            };
            
            // 开始加载图片
            newImg.src = src;
        }
    }
    
    function findList(page) {
        if(isLoading || !hasMore) return;
        isLoading = true;
        $('#loading').show();
        
        var option = {
            pageNo: page,
            pageSize: 25
        }
        
        $.post("/admin/api/findVideoDataList", option, function(data, status) {
            if(data.resCode === "000001") {
                var list = data.record.content;
                
                // 检查是否还有更多数据
                hasMore = list.length > 0 && !data.record.last;
                
                if(list.length > 0) {
                    var html = "";
                    for(var i = 0; i < list.length; i++) {
                        var isPrivate = list[i].videoprivacy === '1';
                        html += '<div class="video-card" data-video="'+list[i].videounrealaddr+'" data-private="'+isPrivate+'">';
                        html += '<div class="video-cover'+(isPrivate ? ' is-private' : '')+'">';
                        html += '<div class="skeleton"></div>';
                        html += '<img data-src="'+list[i].videocover+'" alt="'+list[i].videoname+'" class="lazy-image" onerror="this.src=\'/static/images/noimage.jpg\'">';
                        html += '<div class="video-play"><i class="mdi mdi-'+(isPrivate ? 'lock' : 'play')+'"></i></div>';
                        html += '</div>';
                        html += '<div class="video-info">';
                        html += '<div class="video-title'+(isPrivate ? ' is-private' : '')+'" title="'+(isPrivate ? '' : list[i].videoname)+'">'+(isPrivate ? '******' : list[i].videoname)+'</div>';
                        html += '<div class="video-meta">';
                        html += '<span class="video-platform badge-info">'+(isPrivate ? '****' : list[i].videoplatform)+'</span>';
                        html += '<span class="video-time">'+formatTime(list[i].createtime)+'</span>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                    
                    // 使用requestAnimationFrame优化DOM操作
                    requestAnimationFrame(function() {
                        $('#videoGrid').append(html);
                        
                        // 初始化懒加载
                        initLazyLoading();
                        
                        // 绑定点击事件
                        $('.video-card').off('click').on('click', function() {
                            var $card = $(this);
                            playVideo($card.data('video'), $card.data('private'));
                        });
                    });
                }
            }
            
            isLoading = false;
            $('#loading').hide();
        }).fail(function() {
            isLoading = false;
            $('#loading').hide();
        });
    }
</script>
</body>
</html>